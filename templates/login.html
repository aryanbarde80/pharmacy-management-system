{% extends 'base.html' %}

{% block auth_content %}
<div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-cyan-50 to-blue-100">
  <div class="w-full max-w-md">
    <div class="text-center mb-8">
      <div class="w-16 h-16 rounded-2xl bg-cyan-600 text-white grid place-items-center mx-auto mb-3 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 2a1 1 0 0 0-1 1v2.07A7.002 7.002 0 0 0 5.062 11H4a1 1 0 1 0 0 2h1.062A7.002 7.002 0 0 0 9 18.93V21a1 1 0 1 0 2 0v-2.07A7.002 7.002 0 0 0 18.938 13H20a1 1 0 1 0 0-2h-1.062A7.002 7.002 0 0 0 11 5.07V3a1 1 0 0 0-1-1Z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">{{ _('welcome') }}</h1>
      <p class="text-gray-600 mt-1">{{ _('sign_in_to_continue') }}</p>
    </div>
    <div class="bg-white rounded-2xl shadow-xl">
      <div class="p-6 sm:p-8">
        <div id="errorBox" class="hidden mb-4 p-3 rounded-lg text-sm bg-red-50 text-red-700 border border-red-200" role="alert"></div>
        <form id="loginForm" class="space-y-5">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">{{ _('email_address') }}</label>
            <input id="email" name="email" type="email" dir="ltr" autocomplete="email" required class="w-full rounded-lg border border-gray-300 px-3.5 py-3 text-gray-900 placeholder-gray-400 focus:border-cyan-500" placeholder="you@example.com" />
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label for="password" class="block text-sm font-medium text-gray-700">{{ _('password') }}</label>
              <button type="button" id="togglePassword" class="text-xs text-cyan-700 hover:text-cyan-800">{{ _('show') }}</button>
            </div>
            <input id="password" name="password" type="password" dir="ltr" autocomplete="current-password" required class="w-full rounded-lg border border-gray-300 px-3.5 py-3 text-gray-900 placeholder-gray-400 focus:border-cyan-500" placeholder="••••••••" />
          </div>
          <button id="submitBtn" type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-3">
            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white hidden" id="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            <span id="btnText">{{ _('sign_in') }}</span>
          </button>
        </form>
      </div>
    </div>
    <p class="mt-6 text-center text-sm text-gray-600">
      {{ _('dont_have_account') }}
      <a href="{{ url_for('signup') }}" class="font-medium text-cyan-600 hover:text-cyan-500">{{ _('sign_up') }}</a>
    </p>
    <p class="mt-2 text-center text-xs text-gray-500">
      &copy; {{ g.now.year }} {{ _('all_rights_reserved') }}
    </p>
  </div>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<!-- Project Firebase Config (client-side) -->
<script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Get DOM elements
      const form = document.getElementById('loginForm');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const spinner = document.getElementById('spinner');
      const errorBox = document.getElementById('errorBox');
      const togglePassword = document.getElementById('togglePassword');
      
      // Set current language
      const currentLang = '{{ g.lang }}' || 'en';
      let isLoading = false;

      // Toggle password visibility
      if (togglePassword) {
        togglePassword.addEventListener('click', function() {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          this.textContent = type === 'password' ? '{{ _("show") }}' : '{{ _("hide") }}';
        });
      }

      // Show error message
      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.remove('hidden');
        
        // Reset form state
        submitBtn.disabled = false;
        btnText.textContent = '{{ _("sign_in") }}';
        spinner.classList.add('hidden');
        isLoading = false;
      }

      // Set loading state
      function setLoading(loading) {
        isLoading = loading;
        submitBtn.disabled = loading;
        btnText.textContent = loading ? '{{ _("signing_in") }}...' : '{{ _("sign_in") }}';
        if (spinner) {
          loading ? spinner.classList.remove('hidden') : spinner.classList.add('hidden');
        }
      }

      // Handle form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Prevent multiple submissions
        if (isLoading) return;
        
        // Validate email
        if (!emailInput.value.includes('@')) {
          showError('{{ _("invalid_email") }}');
          return;
        }
        
        // Set loading state
        setLoading(true);
        errorBox.classList.add('hidden');
        
        try {
          // Sign in with Firebase
          const userCredential = await firebase.auth().signInWithEmailAndPassword(emailInput.value, passwordInput.value);
          const idToken = await userCredential.user.getIdToken();
          
          // Send token to backend for session creation
          const response = await fetch('/verify-token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              token: idToken,
              language: currentLang
            }),
          });
          
          if (response.ok) {
            // Redirect to dashboard on success
            window.location.href = '/dashboard';
          } else {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || '{{ _("login_error") }}');
          }
        } catch (error) {
          // Handle Firebase and network errors
          let errorMessage = '{{ _("login_error") }}';
          
          if (error.code) {
            switch (error.code) {
              case 'auth/user-not-found':
                errorMessage = '{{ _("user_not_found") }}';
                break;
              case 'auth/wrong-password':
                errorMessage = '{{ _("wrong_password") }}';
                break;
              case 'auth/invalid-email':
                errorMessage = '{{ _("invalid_email") }}';
                break;
              case 'auth/user-disabled':
                errorMessage = '{{ _("account_disabled") }}';
                break;
              default:
                console.error('Login error:', error);
                errorMessage = error.message || '{{ _("login_error") }}';
            }
          } else {
            console.error('Login error:', error);
            errorMessage = error.message || '{{ _("login_error") }}';
          }
          
          showError(errorMessage);
          console.log('Already signed in as', user.uid);
        }
      });
    });
  </script>
</div>
</div>
</div>
{% endblock %}
